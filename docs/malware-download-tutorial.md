# How to Download Malware Samples for Training

This guide explains how to acquire malware samples using the included downloader, which fetches from [MalwareBazaar](https://bazaar.abuse.ch/) — a free, community-driven malware sample repository run by abuse.ch.

## Safety Precautions

**Malware samples are dangerous.** Follow these precautions:

1. **Use an isolated environment** — a VM (VirtualBox, VMware, or cloud instance) or a dedicated analysis machine. Never download malware on your daily-use system.
2. **Disable auto-execution** — ensure your OS does not auto-run downloaded files.
3. **Use a non-privileged user** — don't run the downloader as root/admin.
4. **Network isolation** — if possible, disconnect the VM from your local network after downloading. Use NAT-only networking.
5. **Antivirus exceptions** — your host AV may quarantine or delete downloaded samples. Add the data directory to your AV exclusion list (in the VM only).
6. **Disk encryption** — store samples on an encrypted volume so they can't leak if the disk is lost.
7. **Clean up** — delete samples when you no longer need them.

## Prerequisites

```bash
cd learner/
pip install -r requirements.txt
```

## Quick Start

The simplest way to get started:

```bash
python learner.py --download
```

This downloads 100 malware samples from MalwareBazaar and collects 100 benign samples from your system binaries (`/usr/bin`, `/usr/local/bin`, etc.).

## MalwareBazaar API Setup

### Without an API Key (Default)

The downloader works without authentication using MalwareBazaar's `get_recent` endpoint. This returns the most recent submissions and is rate-limited but sufficient for small datasets.

### With an API Key (Recommended for Larger Datasets)

1. Create an account at [https://bazaar.abuse.ch/](https://bazaar.abuse.ch/)
2. Go to your profile and find your API key
3. Set the environment variable:

```bash
export MALWAREBAZAAR_API_KEY="your_api_key_here"
```

The downloader automatically uses the API key when available.

## Using the Downloader

### Download Malware Samples

```bash
# Download 100 PE (Windows executable) samples (default)
python learner.py --download --malware-count 100

# Download 200 samples
python learner.py --download --malware-count 200
```

Samples are saved to `data/malware/{sha256}` and a manifest is written to `data/malware_manifest.json`.

### Collect Benign Samples

Benign samples are collected automatically during `--download` by copying executables from system directories:

- **Linux/macOS:** `/usr/bin`, `/usr/local/bin`, `/usr/sbin`
- **Windows:** `C:\Windows\System32`, `C:\Windows\SysWOW64`

```bash
# Collect 100 benign samples (default)
python learner.py --download --benign-count 100

# Collect 500 benign samples
python learner.py --download --benign-count 500
```

Samples are deduplicated by SHA256 hash and saved to `data/benign/{sha256}`.

### Custom Data Directory

```bash
python learner.py --download --data-dir /path/to/data
```

## How Downloads Work

1. **Query MalwareBazaar** — the downloader calls the REST API at `https://mb-api.abuse.ch/api/v1/` to get recent sample metadata (SHA256 hashes, file types, etc.)

2. **Download each sample** — for each hash, the downloader requests the file via the `get_file` endpoint. Files are returned as AES-encrypted ZIP archives (password: `infected`).

3. **Extract and verify** — each ZIP is extracted and the SHA256 hash of the extracted file is verified against the expected hash. Mismatches are discarded.

4. **Save** — verified samples are saved to `data/malware/{sha256}`.

5. **Manifest** — metadata is saved to `data/malware_manifest.json`:
   ```json
   [
     {
       "sha256": "abc123...",
       "source": "malwarebazaar",
       "path": "data/malware/abc123..."
     }
   ]
   ```

## Full Training Pipeline

After downloading samples, you can train and export the model in one command:

```bash
python learner.py --download --train --export
```

Or run each phase separately:

```bash
# Phase 1: Download samples
python learner.py --download

# Phase 2: Train the ConvLSTM model
python learner.py --train --epochs 100 --batch-size 8

# Phase 3: Export to ONNX
python learner.py --export
```

The final output is `models/malware_convlstm.onnx` and `models/feature_config.json`, which are consumed by the Rust scanner.

## Troubleshooting

**"Connection timed out" or "HTTP 429"**
MalwareBazaar rate-limits unauthenticated requests. Wait a few minutes and retry, or set up an API key.

**"Hash mismatch" warnings**
The API occasionally returns corrupted downloads. The downloader skips these automatically. If too many fail, retry later.

**"Permission denied" during benign collection**
Some system binaries aren't readable by normal users. The downloader skips these. Run with `sudo` if you need more samples (not recommended in general).

**Antivirus deleting samples**
Add the `data/malware/` directory to your antivirus exclusion list. On Windows Defender:
```
Settings > Virus & threat protection > Exclusions > Add exclusion > Folder
```
